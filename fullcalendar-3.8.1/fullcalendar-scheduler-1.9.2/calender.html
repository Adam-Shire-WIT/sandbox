<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sandbox Calendar</title>
<meta http-equiv="Refresh" content="900">
<meta charset='utf-8' />
<link href='..\fullcalendar.min.css' rel='stylesheet' />
<link href='..\fullcalendar.print.min.css' rel='stylesheet' media='print' />
<link href='scheduler.min.css' rel='stylesheet' />
<script src='lib\moment.min.js'></script>
<script src='lib\jquery.min.js'></script>
<script src='lib\jquery-ui.min.js'></script>
<script src='lib\fullcalendar.min.js'></script>
<script src='scheduler.min.js'></script>
<script src="https://www.gstatic.com/firebasejs/4.9.0/firebase.js"></script>
<script>
var Name;
var evstart;
var evend;
var printer;
var i=0;
var j=0;
var id=0;
var allDay;
var ID;
var obj;
var count=0;
var eventdata ;
var data;
var datas;
var key;
var keys;
var arr;
var k;
var start;
var end;
var duration;
//url: 'https://sandbox-ui.firebaseio.com/sandbox-ui/events.json';
//config info for the firebase database
var config = {
        apiKey: "AIzaSyD7WKW8wD07hQ4fTA_gUT3xHFCUVOGqR4E",
        authDomain: "sandbox-ui.firebaseapp.com",
        databaseURL: "https://sandbox-ui.firebaseio.com",
        projectId: "sandbox-ui",
        storageBucket: "sandbox-ui.appspot.com",
        messagingSenderId: "1064917041181"
      };
	  //initialization of the firebasre database for use in the code below, sets database reference to the events node of the database
		firebase.initializeApp(config);
		  firebase.database().ref('sandbox-ui/events').on("value", function(snapshot) {
         //  console.log(snapshot.val());
          eventdata= snapshot.val();//setting eventdata to be the data retrieved by snapshot.val
		  // console.log(eventdata);
           keys = Object.keys(eventdata);
           //console.log(keys);
          snapshot.forEach(function (childSnapshot) {
             key = childSnapshot.key;
             datas = childSnapshot.val();
        //    console.log(key, datas);
          })
            //console.log('Getting Feed From', key, data.username, index);
            //getFeed(key);
           while( i<keys.length){//loop that pulls out individual information from each entry for troubleshooting purposes
            k = keys[i];
			//console.log(k);
            Name =eventdata[k].title;
			//console.log('title:',Name);
            evstart = eventdata[k].start;
		//	console.log('start:',evstart);
            evend = eventdata[k].end;
		//	console.log('end:',evend);
			allDay = eventdata[k].allDay;
		//	console.log('allDay:',allDay);
			printer = eventdata[k].resourceId;
		//	console.log('resourceId:',printer);
			id = eventdata[k].id;
		//	console.log('id:',id);
			i++;
      count=i;
			}
			});
		 function gotData(data) {
    console.log(data);//taking the data from the database
	 data=data;
	 arr = Object.keys(data).map(function(k) { return data[k] });//converting from JSON object into an array for use with events function of Fullcalender
	 console.log(arr);
  }

  $(function() { // document ready
    /* initialize the external events
    -----------------------------------------------------------------*/

    $('#external-events .fc-event').each(function() {

      // store data so the calendar knows to render an event upon drop
      $(this).data('event', {
        title: $.trim($(this).text()), // use the element's text as the event title
        stick: true // maintain when user navigates (see docs on the renderEvent method)
      });

      // make the event draggable using jQuery UI
      $(this).draggable({
        zIndex: 999,
        revert: true,      // will cause the event to go back to its
        revertDuration: 0  //  original position after the drag
      });

    });


    /* initialize the calendar
    -----------------------------------------------------------------*/
	var database = firebase.database().ref('sandbox-ui/events');//setting database to be the reference to our events node
    $('#calendar').fullCalendar({
      schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
      //now: $('#calendar').fullCalendar('getDate'),
	  // days of week. an array of zero-based day of week integers (0=Sunday), broken into two arrays to allow for different hours for weekend days
	  businessHours:[ {
    dow: [ 1, 2, 3, 4, 5 ], // Monday - Friday

    start: '9:00', // a start time 9am
    end: '18:00', // an end time 6pm
		},
		{
        dow: [ 0,6 ], // Sunday, Saturday
        start: '12:00', // noon
        end: '17:00' // 5pm
    } ],
	  timezone: 'local',
      header: {
	  //header of calender
        left: 'today prev,next',
        center: 'title',
        right: 'timelineDay'
      },
      height:"auto",//set height of rendered calender, auto is set to allow for Fullcalender to determine best fit size
      //contentHeight:"auto",
        editable: true, // enable draggable events
        droppable: true, // this allows things to be dropped onto the calendar
        //aspectRatio: 3, unneeded due to height value being set
        scrollTime: '09:00',// undo default 6am scrollTime
        nowIndicator: true,
        slotLabelInterval:'01:00:00',
        slotDuration:'00:15:00',
        snapDuration:'00:15:00',
        eventLongPressDelay:1000,
        longPressDelay:1000,
        selectLongPressDelay:1000,
        defaultView: 'timelineDay',
        resourceLabelText: '3D Printers',
	  resourceAreaHeight: '100%',
	  eventOverlap: false,
	  events: arr,
      resources: [
        { id: 'a', title: 'MakerBot 1' },
        { id: 'b', title: 'MakerBot 2', eventColor: 'orange' },
        { id: 'c', title: 'MakerBot 3', eventColor: '#af41f4' },
		    { id: 'd', title: 'MakerBot Z18', eventColor: 'red' },
    		{ id: 'e', title: 'Taz 6', eventColor: '#77f442' },
      //{ id: 'f', title: 'Robo1', eventColor: 'cyan' }, robo printers, commented out as not avaiable yet
	  //{ id: 'g', title: 'Robo2', eventColor: 'maroon' },
	  //{ id: 'h', title: 'Robo3', eventColor: 'purple' },
      ],
      drop: function(date, jsEvent, ui, resourceId) {
        console.log('drop', date.format(), resourceId);

      },
      eventReceive: function(event) { // called when a proper external event is dropped
        console.log('eventReceive', event);
          duration = moment.duration(event.end - event.start);
          //var dur=event.start.format('YYYY-MM-DD HH:mm:SS')-event.end.format('YYYY-MM-DD HH:mm:SS');
          alert("Length of Print:"+ duration.hours()+' hours:'+duration.minutes()+' minutes')
          $('#calendar').fullCalendar('updateEvent',event);

      },
      eventDrop: function(event) { // called when an event (already on the calendar) is moved
        console.log('eventDrop', event);

        var h=keys[event.id];
        //set h to be the value of key, which currently is the last key in the eventdata snapshot from firebase
        if(h==undefined){

        }
        else{
        database = firebase.database();
    var firebaseRef=firebase.database().ref('sandbox-ui/events/'+h);
      firebaseRef.update({resourceId:event.resourceId});
      firebaseRef.update({start:event.start.format('YYYY-MM-DD HH:mm')});
      firebaseRef.update({end:event.end.format('YYYY-MM-DD HH:mm')});
      $('#calendar').fullCalendar('updateEvent',event);
    $("#calendar").fullCalendar('removeEvents');
    gotData(eventdata);
    $("#calendar").fullCalendar('addEventSource', arr);
    $('#calendar').fullCalendar( 'rerenderEvents');
  }

},
  eventResize: function(event) {
        var duration = moment.duration(event.end - event.start);
          if (event.title=="Print: Name"){
            //alert(h);event.end=event.end;
            //var dur=event.start.format('YYYY-MM-DD HH:mm:SS')-event.end.format('YYYY-MM-DD HH:mm:SS');
          //alert("Length of Print:"+ duration.hours()+' hours:'+duration.minutes()+' minutes')
            //var dur=event.start.format('YYYY-MM-DD HH:mm')-event.end.format('YYYY-MM-DD HH:mm');
            alert(event.start.format('YYYY-MM-DD HH:mm'));
            alert(event.end.format('YYYY-MM-DD HH:mm'));
          alert("Length of Print:"+ duration.hours()+' hours:'+duration.minutes()+' minutes')
          	$('#calendar').fullCalendar('updateEvent',event);
          }
        //set h to be the value of key, which currently is the last key in the eventdata snapshot from firebase
   else {
     //alert(event.id);
     var h=keys[event.id];
    //alert(h);
    database = firebase.database();
    var firebaseRef=firebase.database().ref('sandbox-ui/events/'+h);
     alert("Length of Print:"+ duration.hours()+' hours:'+duration.minutes()+' minutes');
     alert(event.start);
     alert(event.end);
    $('#calendar').fullCalendar('updateEvent',event);
    firebaseRef.update({allDay:false});
    firebaseRef.update({start:event.start.format('YYYY-MM-DD HH:mm')});
    firebaseRef.update({end:event.end.format('YYYY-MM-DD HH:mm')});
  firebaseRef.update({id:count-1});
  firebaseRef.update({resourceId:event.resourceId});
    $("#calendar").fullCalendar('removeEvents');
    gotData(eventdata);
    $("#calendar").fullCalendar('addEventSource', arr);
     $('#calendar').fullCalendar( 'rerenderEvents');
}
 },
	  eventClick: function(event, jsEvent, view) {
      //var things=event.id-1;
		  //var length=event.end.diff(event.start, 'minutes');
		  //var length=(end-start);
  if (event.title==="Print: Name"){
    var title = prompt('Event Title:', event.title, { buttons: { Ok: true, Cancel: false} });
    if(title==="Print: Name"){
      event.title="change";
    }
    else{
    event.title = title;
}
     var h=keys[event.id];
     if (h==undefined){
       database = firebase.database();
       var firebaseRef=firebase.database().ref('sandbox-ui/events').push();
       firebaseRef.child("title").set(event.title);
         firebaseRef.child("allDay").set(false);
          firebaseRef.child("start").set(event.start.format('YYYY-MM-DD HH:mm'));
           firebaseRef.child("end").set(event.end.format('YYYY-MM-DD HH:mm'));
           firebaseRef.child("id").set(count-1);
            firebaseRef.child("resourceId").set(event.resourceId);
            $('#calendar').fullCalendar('updateEvent',event);
       console.log(count);
       $("#calendar").fullCalendar('removeEvents');
       gotData(eventdata);
       $("#calendar").fullCalendar('addEventSource', arr);
       $('#calendar').fullCalendar( 'rerenderEvents');
     }
     else{
    database = firebase.database();
    var firebaseRef=firebase.database().ref('sandbox-ui/events'+h);
  //  firebaseRef.update({start:start.format('YYYY-MM-DDTHH:MM:SS')});
  //  firebaseRef.update({end:end.format('YYYY-MM-DDTHH:MM:SS')});
    firebaseRef.update({title:event.title});
      firebaseRef.update({allDay:false});
      firebaseRef.update({start:event.start.format('YYYY-MM-DD HH:mm')});
      firebaseRef.update({end:event.end.format('YYYY-MM-DD HH:mm')});
    firebaseRef.update({id:count-1});
    firebaseRef.update({resourceId:event.resourceId});
  //  var resourceId=event.resourceId;
  //  var resourceId=event.resourceId;
    console.log(count);
    $('#calendar').fullCalendar('updateEvent',event);
    $("#calendar").fullCalendar('removeEvents');
    gotData(eventdata);
    $("#calendar").fullCalendar('addEventSource', arr);
    $('#calendar').fullCalendar( 'rerenderEvents');
  }
}
  else if(confirm('Do you wish to rename this print?')) {
      var title = prompt('Event Title:', event.title, { buttons: { Ok: true, Cancel: false} });
      var h=keys[event.id];
    //  alert(event.id);
    //  alert(h);
       event.title = title;
  //ar idforchange= snapshot.val();
//rootRef.child(rowId).remove()
//event.title = title;
//alert(event.title);
database = firebase.database();
firebaseRef=firebase.database().ref('sandbox-ui/events/'+h);
firebaseRef.update({title:event.title});
$('#calendar').fullCalendar('updateEvent',event);
$("#calendar").fullCalendar('removeEvents');
gotData(eventdata);
$("#calendar").fullCalendar('addEventSource', arr);
$('#calendar').fullCalendar( 'rerenderEvents');
  }
    else if(confirm('Do you wish to Delete this print?')) {
      var h=keys[event.id];
    // alert(event.id);      //salert(h);
       //event.title = Deleted;
       //ar idforchange= snapshot.val();
       //rootRef.child(rowId).remove()
       //event.title = title;
       //alert(event.title);
       if(h==undefined){
         event.id=(count-1);
         h=(count-1);
           //alert(h);
           //alert(event.id);
          $('#calendar').fullCalendar('updateEvent',event);
          database = firebase.database();
         firebaseRef=firebase.database().ref('sandbox-ui/events/'+h);
         firebaseRef.update({title:null});
         firebaseRef.update({start:null});
         firebaseRef.update({end:null});
         firebaseRef.update({resourceId:null});
         $('#calendar').fullCalendar('updateEvent',event);
         $("#calendar").fullCalendar('removeEvents');
         gotData(eventdata);
         $("#calendar").fullCalendar('addEventSource', arr);
         $('#calendar').fullCalendar( 'rerenderEvents');
         //location.reload().reload();
       }
       else{
         var h=keys[event.id];
        //alert(event.id);
      // var duration = moment.duration(event.end - event.start);
         //alert(h);
         //alert(event.id);
         database = firebase.database();
         firebaseRef=firebase.database().ref('sandbox-ui/events/'+h);
       firebaseRef.update({title:null});
       firebaseRef.update({start:null});
       firebaseRef.update({end:null});
       firebaseRef.update({resourceId:null});
       $('#calendar').fullCalendar('updateEvent',event);
       $("#calendar").fullCalendar('removeEvents');
       gotData(eventdata);
       $("#calendar").fullCalendar('addEventSource', arr);
       $('#calendar').fullCalendar( 'rerenderEvents');
       //location.reload().reload();
      // $('#calendar').fullCalendar('updateEvent',event);
}
     }
},
});
	$('#calender').fullCalendar( 'refetchEvents' );
	$('#calendar').fullCalendar('render')
});
function goto(){
  var date = prompt('Enter date:', 'YYYY-MM-DD', { buttons: { Ok: true, Cancel: false} });
    $('#calendar').fullCalendar( 'gotoDate', date );
    $("#calendar").fullCalendar('removeEvents');
    $("#calendar").fullCalendar('addEventSource', arr);
    $('#calendar').fullCalendar( 'rerenderEvents');
}
</script>
<style>
  body {
    text-align: center;
    font-size: 0.875rem;
    font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
    background-color:#616161;
  }
  .jumbo{
    width: 100%;
    height: 8rem;
    background-color: #D32F2F;
    font-size: 1.5rem;
    color:white;
    padding-top: 1rem;
    text-align: center;
  }
  #wrap {
    width: 70rem;
    margin: 0 auto;
  }

  #external-events {
    float: left;
    width: 9.375rem;
    height:10rem;
    border: 0.0625rem solid #ccc;
    background: #eee;
    text-align: left;
  }

  #external-events h4 {
    font-size: 1;
    margin-top: 0;
    padding-top: 1em;
  }

  #external-events .fc-event {
    margin: 10px 0;
    cursor: pointer;
      height:2rem;
  }

  #external-events p {
    margin: 1.5em 0;
    font-size:  0.6875rem;
    color: #666;
  }

  #external-events p input {
    margin: 0;
    vertical-align: middle;
  }

  #calendar {
    float: right;
    width:56rem;
    color:white;
    height:100%;
  }
  .fc-widget-content{
     height: 5rem !important;
}
.fc-timeline-event .fc-h-event .fc-event .fc-start .fc-end .fc-draggable .fc-resizable{
height:3rem !important;
}
.fc-event {
  margin-top: .7rem;
  height: 4em !important;
}
</style>
</head>
<body>
    <div class="jumbo">
  <h1>Technology Sandbox</h1>
    </div>
    <br>
  <div id='wrap'>
    <div id='external-events'>
      <h4>Drag me onto the calendar!</h4>
      <div class='fc-event' data-duration="00:15:00">Print: Name</div>
      <div>
      <button type="button" onclick="goto()" > Go to Date</button></a>
      </div>
    </div>
    <div id='calendar'></div>
    <div style='clear:both'></div>
	</div>
</div>
	<br><br>
	<div>
	<a a href="https://mcnamaras2.github.io/sandbox/"><button type="button"> Return to Sandbox Home Page</button></a>
	</div>
  <script src="https://sandbox-ui.firebaseio.com/sandbox-ui/events.json?callback=gotData"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"> </script>
</body>
</html>
