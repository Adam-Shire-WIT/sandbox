<!DOCTYPE html>
<html>

<head>


</head>

<body>
  <div id="stack"></div>
  <div id="bar"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/1.40.1/plotly.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
  <script>
  const printerNames = {
a: 'Makerbot 1',
b: 'Makerbot 2',
c: 'Makerbot 3',
d: 'Makerbot Z18',
e: 'Taz 6',
f: 'Robo R1 #1',
g: 'Robo R1 #2',
h: 'Robo R1 #3',
i: 'Robo R1 #4',
j: 'Robo R2'
}



var getJSON = function(url) {
return new Promise((resolve, reject) => {
  const xhr = new XMLHttpRequest();
  xhr.open("GET", url);
  xhr.onload = () => resolve(xhr.responseText);
  xhr.onerror = () => reject(xhr.statusText);
  xhr.send();
});
};

getJSON("https://sandbox-ui.firebaseio.com/events.json")
.then(function(results) {
  var data = JSON.parse(results);

  var events = Object.values(data).map(function(event) {

    event.date = moment(event.start).format("YYYY-MM");
    return event;
  });



//remove events that don't have a wit email address

events = events.filter(event => event.title.search('@wit.edu') != -1)

var dateList = [...new Set(events.map(item => item.date))].sort() // Use the spread operator to transform a set into an Array.;
console.log(dateList)


  console.log(events[2]);

  var printers = [];
  events.forEach(function(event) {
    var printer = event.resourceId;
    var date = event.date;

    //check if printer exists in our printer array
    if (!printers[printer]) {
      printers[printer] = {
        //create a new printer object if it doesn't exist
        x: dateList,
        y: Array(dateList.length).fill(0),
        name: printerNames[printer],
        type:"bar"
      };
    }
    //console.log(printers[printer].x)
    var dateIndex = printers[printer].x.indexOf(date)

    //console.log(dateIndex)

    printers[printer].y[dateIndex]++; //index into the current month of the y array and increment
  });

  printers = Object.values(printers)

//sort the printer objects

      function compare(a, b) {

        const printerA = a.name
        const printerB = b.name

        let comparison = 0;
        if (printerA > printerB) {
          comparison = 1;
        } else if (printerA < printerB) {
          comparison = -1;
        }
        return comparison;
      }

      printers.sort(compare) // sort the printers array by printerName




  var stacks = printers;

  var layout = {
    barmode: "stack",
    xaxis: {
      type:"date",
      tickmode:"linear",
      dtick:"M1"
    },
  };

  Plotly.newPlot("stack", stacks, layout);
Plotly.newPlot("bar", stacks, {xaxis: {
  type:"date",
  tickmode:"linear",
  dtick:"M1"
}});
})
.catch(function(err) {
  console.error("Augh, there was an error!", err.statusText);
});

/* Current Plotly.js version */
//console.log( Plotly.BUILD );
  </script>
</body>

</html>
