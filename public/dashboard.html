<!DOCTYPE html>
<html>

<head>


</head>

<body>
  <div id="stack"></div>
  <div id="bar"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/1.40.1/plotly.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
  <script>
    const printerNames = {
      a: 'Makerbot 1',
      b: 'Makerbot 2',
      c: 'Makerbot 3',
      d: 'Makerbot Z18',
      e: 'Taz 6',
      f: 'Robo R1 #1',
      g: 'Robo R1 #2',
      h: 'Robo R1 #3',
      i: 'Robo R1 #4',
      j: 'Robo R2'
    }


    //promisify the XHR
    var getJSON = function(url) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", url);
        xhr.onload = () => resolve(xhr.responseText);
        xhr.onerror = () => reject(xhr.statusText);
        xhr.send();
      });
    };

    getJSON("https://sandbox-ui.firebaseio.com/events.json")
      .then(function(results) {
        var data = JSON.parse(results);

        var events = Object.values(data).map(function(event) {
          event.month = moment(event.start).format("M");
          return event;
        });

        //remove events that don't have a wit email address

        events = events.filter(event => event.title.search('@wit.edu') != -1)


        console.log(events[2]);

        var printers = []; //initialize printers array
        events.forEach(function(event) {
          var printer = event.resourceId;
          var month = +event.month; //coerce to integer

          //check if printer exists in printers array
          if (!printers[printer]) {
            printers[printer] = {
              //create a new printer object if it doesn't exist
              x: [
                "Jan",
                "Feb",
                "Mar",
                "Apr",
                "May",
                "Jun",
                "Jul",
                "Aug",
                "Sep",
                "Oct",
                "Nov",
                "Dec"
              ],
              y: Array(12).fill(0), //positions represent months y[0] = january
              name: printerNames[printer],
              type: "bar"
            };
          }
          //console.log(month)
          printers[printer].y[month - 1]++; //index into the position in the y array representing the month and increment the value
        });

        printers = Object.values(printers) //flatten the objects in the printers array

        //sort the printer objects

        function compare(a, b) {

          const printerA = a.name
          const printerB = b.name

          let comparison = 0;
          if (printerA > printerB) {
            comparison = 1;
          } else if (printerA < printerB) {
            comparison = -1;
          }
          return comparison;
        }

        printers.sort(compare) // sort the printers array by printerName


        var layout = {
          barmode: "stack"
        };

        Plotly.newPlot("stack", printers, layout);
        Plotly.newPlot("bar", printers, {
          barmode: "bar"
        });
      })
      .catch(function(err) {
        console.error("Augh, there was an error!", err.statusText);
      });

    /* Current Plotly.js version */
    //console.log( Plotly.BUILD );
  </script>
</body>

</html
